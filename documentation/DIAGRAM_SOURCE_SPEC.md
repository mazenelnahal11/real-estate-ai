# System Architecture & Data Model Specifications
**Project**: Real Estate AI Assistant Dashboard
**Date**: 2025-12-13
**Purpose**: Source data for generating technical diagrams (ERD, Architecture, Sequence).

---

## 1. Data Model Specification (ERD Source)

### 1.1. Database Engine
- **Type**: Relational Database Management System (RDBMS)
- **Technology**: SQLite 3 (`leads.db`)
- **Storage**: Server-local file.

### 1.2. Tables & Schema

#### Table: `leads`
*Stores all lead interactions, metadata, and scoring results.*

| Column Name | Data Type | Key | Nullable | Description |
| :--- | :--- | :--- | :--- | :--- |
| `chat_id` | TEXT | **PK** | No | Unique Session ID (Base36/Hex). Primary Key. |
| `name` | TEXT | | Yes | Extracted customer name. |
| `phone` | TEXT | | Yes | Extracted phone number (High Value). |
| `budget` | TEXT | | Yes | Budget range or exact value string. |
| `heat_score`| INTEGER | | Yes | Deterministic score (0-100). |
| `summary` | TEXT | | Yes | AI-generated summary of the conversation. |
| `start_time`| DATETIME | | No | Timestamp of the first interaction. |
| `area` | TEXT | | Yes | Requested property size (sqm). |
| `location` | TEXT | | Yes | Requested location (e.g., "New Cairo"). |
| `unit_type` | TEXT | | Yes | Apartment, Villa, Chalet, etc. |
| `call_requested` | INTEGER | | No | Boolean flag (0=False, 1=True). |
| `best_call_time` | TEXT | | Yes | Preferred contact window string. |

*(Note: `tonality` is calculated in memory for scoring but currently flattened into `heat_score` for storage.)*

### 1.3. JSON Data Structures

#### Object: `LeadMetadata` (In-Memory)
*Generated by `llm.js` -> Used by `ScoreService`*
```json
{
  "name": "String | null",
  "phone": "String | null",
  "budget": "Number | null",
  "location": "String | null",
  "unit_type": "String | null",
  "tonality": "Enum('Urgent', 'Positive', 'Neutral', 'Negative')",
  "call_requested": "Boolean",
  "best_call_time": "String | null"
}
```

---

## 2. System Architecture Specification (Diagram Source)

### 2.1. High-Level Components
1.  **Client Layer**:
    -   **Web Browser**: Renders HTML/CSS. Executes client-side JS (`dashboardController.js`).
2.  **Application Layer (Monolith)**:
    -   **Node.js Runtime**: Hosted environment.
    -   **Express.js Framework**: Handles HTTP Routing/Middleware.
    -   **Service Layer**: Encapsulates business logic (`ScoreService`, `LLMService`).
3.  **Data Layer**:
    -   **SQLite**: Local persistence.
    -   **Google Sheets**: External secondary storage (via API).
4.  **External Services**:
    -   **Google Gemini AI**: Inference API (Generative/Extraction).

### 2.2. Component Interaction Map

*   **User** <--> **Routes** (`/`, `/chat`)
*   **Routes** --> **Service Layer**
*   **Service: LLM** <--> **Google Gemini API** (HTTPS)
*   **Service: Sheets** <--> **Google Sheets API** (HTTPS)
*   **Service: LeadService** <--> **SQLite** (Native Driver)
*   **Service: ScoreService** (Internal Calculation)

### 2.3. Detailed Data Flows (Sequence Diagrams)

#### Flow A: Chat Message Lifecycle
1.  **Actor**: User sends Message.
2.  **Interface**: `POST /chat/message`
3.  **Controller**: `chatRoutes.js`
    -   Calculates `ResponseLatency`.
4.  **Service**: `LLMService`
    -   Fetch Context -> Query Gemini -> Return `Response`.
    -   Query Gemini -> Return `LeadMetadata` (JSON).
5.  **Service**: `ScoreService`
    -   Input: `LeadMetadata` + `ResponseLatency`.
    -   Process: Formula Logic.
    -   Output: `HeatScore`.
6.  **Persistence**:
    -   Write to `SQLite`.
    -   Write to `Google Sheets`.
7.  **Return**: JSON `{ reply: "..." }` to User.

#### Flow B: Dashboard Real-Time Poll
1.  **Actor**: Admin (Browser).
2.  **Timer**: `setInterval(30s)`.
3.  **Interface**: `GET /api/dashboard-stats`.
4.  **Controller**: `dashboardRoutes.js`.
5.  **Service**: `LeadService`.
    -   Query: `SELECT count(*) ... WHERE heat_score > 75`.
6.  **Return**: JSON Metrics.
7.  **Client**: Update DOM elements.

---

## 3. Technology Stack & Attributes
-   **Frontend**: EJS (Templating), Tailwind CSS v4 (Styling).
-   **Backend**: Node.js (v18+), Express (v5).
-   **Database**: SQLite3.
-   **AI Model**: Gemini 2.0 Flash.
-   **Security**: HTTP-Only Cookies, Environment Variable Secrets (`.env`).
